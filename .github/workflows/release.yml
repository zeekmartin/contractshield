name: Release

on:
  push:
    tags:
      - 'v*'

permissions: read-all

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup pnpm
        uses: pnpm/action-setup@c5ba7f7862a0f64c1b1a05fbac13e0b8e86ba08c # v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      # Obfuscate Pro modules before publishing
      - name: Obfuscate Pro modules
        run: |
          npm install -g javascript-obfuscator

          # Obfuscate all JS files in pro packages dist folders
          for pro_pkg in pro/sink-rasp pro/learning pro/license-online pro/pro; do
            if [ -d "$pro_pkg/dist" ]; then
              echo "Obfuscating $pro_pkg..."
              find "$pro_pkg/dist" -name "*.js" -type f | while read file; do
                echo "  â†’ $file"
                javascript-obfuscator "$file" \
                  --output "$file" \
                  --compact true \
                  --control-flow-flattening true \
                  --control-flow-flattening-threshold 0.75 \
                  --dead-code-injection true \
                  --dead-code-injection-threshold 0.4 \
                  --string-array true \
                  --string-array-encoding 'rc4' \
                  --string-array-threshold 0.75 \
                  --transform-object-keys true \
                  --unicode-escape-sequence true
              done
            fi
          done

      # Publish all packages
      - name: Publish packages
        run: |
          # Open source packages first
          for pkg in packages/license packages/pdp packages/pep-express packages/pep-fastify packages/sidecar packages/client packages/core; do
            echo "Publishing $pkg..."
            cd $pkg && npm publish --access public --provenance || true
            cd -
          done

          # Pro packages (now obfuscated)
          for pkg in pro/sink-rasp pro/learning pro/license-online pro/pro; do
            echo "Publishing $pkg (obfuscated)..."
            cd $pkg && npm publish --access public --provenance || true
            cd -
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
