"""Tests for vulnerability scanning."""

import pytest

from contractshield.vulnerability import (
    VulnerabilityScanner,
    VulnerabilityType,
    SQLiChecker,
    XSSChecker,
    PathTraversalChecker,
    PrototypePollutionChecker,
    SSRFChecker,
    NoSQLInjectionChecker,
    CommandInjectionChecker,
)
from contractshield.core import Severity


class TestSQLiChecker:
    """Test SQL injection detection."""

    def test_detects_union_select(self):
        checker = SQLiChecker()
        findings = checker.check("1 UNION SELECT * FROM users", "$")
        assert len(findings) == 1
        assert findings[0].type == VulnerabilityType.SQLI
        assert findings[0].severity == Severity.CRITICAL

    def test_detects_comment_injection(self):
        checker = SQLiChecker()
        findings = checker.check("admin'--", "$")
        assert len(findings) == 1

    def test_detects_boolean_injection(self):
        checker = SQLiChecker()
        findings = checker.check("' OR 1=1 --", "$")
        assert len(findings) == 1

    def test_ignores_safe_strings(self):
        checker = SQLiChecker()
        findings = checker.check("normal search query", "$")
        assert len(findings) == 0

    def test_ignores_short_strings(self):
        checker = SQLiChecker()
        findings = checker.check("ab", "$")
        assert len(findings) == 0


class TestXSSChecker:
    """Test XSS detection."""

    def test_detects_script_tag(self):
        checker = XSSChecker()
        findings = checker.check("<script>alert('xss')</script>", "$")
        assert len(findings) == 1
        assert findings[0].type == VulnerabilityType.XSS

    def test_detects_event_handler(self):
        checker = XSSChecker()
        findings = checker.check("<img onerror='alert(1)'>", "$")
        assert len(findings) == 1

    def test_detects_javascript_uri(self):
        checker = XSSChecker()
        findings = checker.check("javascript:alert(1)", "$")
        assert len(findings) == 1

    def test_ignores_safe_html(self):
        checker = XSSChecker()
        findings = checker.check("<div class='test'>Hello</div>", "$")
        assert len(findings) == 0


class TestPathTraversalChecker:
    """Test path traversal detection."""

    def test_detects_dot_dot_slash(self):
        checker = PathTraversalChecker()
        findings = checker.check("../../../etc/passwd", "$.path")
        assert len(findings) == 1
        assert findings[0].type == VulnerabilityType.PATH_TRAVERSAL

    def test_detects_encoded_traversal(self):
        checker = PathTraversalChecker()
        findings = checker.check("%2e%2e%2f%2e%2e%2fetc/passwd", "$.path")
        assert len(findings) == 1

    def test_detects_absolute_path(self):
        checker = PathTraversalChecker()
        findings = checker.check("/etc/passwd", "$.path")
        assert len(findings) == 1

    def test_ignores_safe_paths(self):
        checker = PathTraversalChecker()
        findings = checker.check("images/photo.jpg", "$.path")
        assert len(findings) == 0


class TestPrototypePollutionChecker:
    """Test prototype pollution detection."""

    def test_detects_proto(self):
        checker = PrototypePollutionChecker()
        findings = checker.check("__proto__", "$")
        assert len(findings) == 1
        assert findings[0].type == VulnerabilityType.PROTOTYPE_POLLUTION
        assert findings[0].severity == Severity.CRITICAL

    def test_detects_constructor(self):
        checker = PrototypePollutionChecker()
        findings = checker.check("constructor", "$")
        assert len(findings) == 1

    def test_detects_case_variations(self):
        checker = PrototypePollutionChecker()
        findings = checker.check("__PROTO__", "$")
        assert len(findings) == 1
        assert findings[0].severity == Severity.HIGH


class TestSSRFChecker:
    """Test SSRF detection."""

    def test_detects_localhost(self):
        checker = SSRFChecker()
        findings = checker.check("http://localhost:8080/api", "$")
        assert len(findings) == 1
        assert findings[0].type == VulnerabilityType.SSRF_INTERNAL

    def test_detects_private_ip(self):
        checker = SSRFChecker()
        findings = checker.check("http://192.168.1.1/admin", "$")
        assert len(findings) == 1

    def test_detects_metadata_endpoint(self):
        checker = SSRFChecker()
        findings = checker.check("http://169.254.169.254/latest/meta-data/", "$")
        assert len(findings) == 1
        assert findings[0].severity == Severity.CRITICAL

    def test_ignores_public_urls(self):
        checker = SSRFChecker()
        findings = checker.check("https://api.example.com/v1/data", "$")
        assert len(findings) == 0


class TestNoSQLInjectionChecker:
    """Test NoSQL injection detection."""

    def test_detects_where_operator(self):
        checker = NoSQLInjectionChecker()
        findings = checker.check({"$where": "this.password == 'test'"}, "$")
        assert len(findings) >= 1

    def test_detects_ne_operator(self):
        checker = NoSQLInjectionChecker()
        findings = checker.check({"$ne": ""}, "$")
        assert len(findings) >= 1

    def test_detects_js_injection(self):
        checker = NoSQLInjectionChecker()
        findings = checker.check("function() { return true; }", "$")
        assert len(findings) == 1


class TestCommandInjectionChecker:
    """Test command injection detection."""

    def test_detects_pipe(self):
        checker = CommandInjectionChecker()
        findings = checker.check("file.txt | cat /etc/passwd", "$")
        assert len(findings) == 1
        assert findings[0].type == VulnerabilityType.COMMAND_INJECTION

    def test_detects_semicolon(self):
        checker = CommandInjectionChecker()
        findings = checker.check("file.txt; rm -rf /", "$")
        assert len(findings) == 1

    def test_detects_backticks(self):
        checker = CommandInjectionChecker()
        findings = checker.check("`whoami`", "$")
        assert len(findings) == 1

    def test_detects_command_substitution(self):
        checker = CommandInjectionChecker()
        findings = checker.check("$(cat /etc/passwd)", "$")
        assert len(findings) == 1


class TestVulnerabilityScanner:
    """Test the main vulnerability scanner."""

    def test_scans_nested_objects(self):
        scanner = VulnerabilityScanner()
        data = {
            "user": {
                "name": "test",
                "query": "1 UNION SELECT * FROM users",
            }
        }
        findings = scanner.scan(data)
        assert len(findings) >= 1
        assert any(f.type == VulnerabilityType.SQLI for f in findings)

    def test_scans_arrays(self):
        scanner = VulnerabilityScanner()
        data = {
            "items": [
                {"name": "safe"},
                {"name": "<script>alert(1)</script>"},
            ]
        }
        findings = scanner.scan(data)
        assert len(findings) >= 1
        assert any(f.type == VulnerabilityType.XSS for f in findings)

    def test_checks_dict_keys(self):
        scanner = VulnerabilityScanner()
        data = {"__proto__": {"admin": True}}
        findings = scanner.scan(data)
        assert len(findings) >= 1
        assert any(f.type == VulnerabilityType.PROTOTYPE_POLLUTION for f in findings)

    def test_respects_max_depth(self):
        scanner = VulnerabilityScanner()
        # Create deeply nested structure
        data = {"level": {"level": {"level": {"attack": "' OR 1=1 --"}}}}
        findings = scanner.scan(data, max_depth=2)
        # Should not find the attack at depth 4
        assert len(findings) == 0

    def test_can_disable_checks(self):
        scanner = VulnerabilityScanner(enable_sqli=False)
        findings = scanner.scan({"query": "1 UNION SELECT * FROM users"})
        # SQLi should not be detected
        sqli_findings = [f for f in findings if f.type == VulnerabilityType.SQLI]
        assert len(sqli_findings) == 0
