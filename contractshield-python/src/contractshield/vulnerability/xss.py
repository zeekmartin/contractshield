"""Cross-Site Scripting (XSS) detection."""

import re
from typing import Any, List, Optional

from contractshield.core.result import Severity

from .scanner import VulnerabilityFinding, VulnerabilityType, truncate_value


class XSSChecker:
    """
    XSS (Cross-Site Scripting) vulnerability checker.

    Detects common XSS patterns in string values.
    """

    # Script tag patterns
    SCRIPT_PATTERNS = [
        re.compile(r"<\s*script\b", re.IGNORECASE),
        re.compile(r"<\s*/\s*script\s*>", re.IGNORECASE),
    ]

    # Event handler patterns
    EVENT_PATTERNS = [
        re.compile(r"\bon\w+\s*=", re.IGNORECASE),  # onclick=, onerror=, etc.
    ]

    # JavaScript URL patterns
    JS_URL_PATTERNS = [
        re.compile(r"javascript\s*:", re.IGNORECASE),
        re.compile(r"vbscript\s*:", re.IGNORECASE),
        re.compile(r"data\s*:\s*text/html", re.IGNORECASE),
    ]

    # HTML injection patterns
    HTML_PATTERNS = [
        re.compile(r"<\s*iframe\b", re.IGNORECASE),
        re.compile(r"<\s*object\b", re.IGNORECASE),
        re.compile(r"<\s*embed\b", re.IGNORECASE),
        re.compile(r"<\s*img\b[^>]*\bon\w+\s*=", re.IGNORECASE),
        re.compile(r"<\s*svg\b[^>]*\bon\w+\s*=", re.IGNORECASE),
        re.compile(r"<\s*body\b[^>]*\bon\w+\s*=", re.IGNORECASE),
    ]

    # Expression patterns
    EXPRESSION_PATTERNS = [
        re.compile(r"expression\s*\(", re.IGNORECASE),
        re.compile(r"url\s*\(\s*['\"]?\s*javascript:", re.IGNORECASE),
    ]

    # Encoded patterns
    ENCODED_PATTERNS = [
        re.compile(r"&#x?[0-9a-f]+;", re.IGNORECASE),  # HTML entities
        re.compile(r"\\u[0-9a-f]{4}", re.IGNORECASE),  # Unicode escapes
    ]

    def check(
        self, value: Any, path: str, fields: Optional[List[str]] = None
    ) -> List[VulnerabilityFinding]:
        """Check value for XSS patterns."""
        findings: List[VulnerabilityFinding] = []

        if not isinstance(value, str):
            return findings

        # Skip very short strings
        if len(value) < 3:
            return findings

        # Check script patterns (highest severity)
        for pattern in self.SCRIPT_PATTERNS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.XSS,
                        severity=Severity.CRITICAL,
                        path=path,
                        value=truncate_value(value),
                        message="Script tag detected",
                    )
                )
                return findings

        # Check event handler patterns
        for pattern in self.EVENT_PATTERNS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.XSS,
                        severity=Severity.HIGH,
                        path=path,
                        value=truncate_value(value),
                        message="Event handler attribute detected",
                    )
                )
                return findings

        # Check JavaScript URL patterns
        for pattern in self.JS_URL_PATTERNS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.XSS,
                        severity=Severity.CRITICAL,
                        path=path,
                        value=truncate_value(value),
                        message="JavaScript URL scheme detected",
                    )
                )
                return findings

        # Check HTML injection patterns
        for pattern in self.HTML_PATTERNS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.XSS,
                        severity=Severity.HIGH,
                        path=path,
                        value=truncate_value(value),
                        message="Potentially dangerous HTML tag detected",
                    )
                )
                return findings

        return findings
