"""NoSQL Injection detection."""

import re
from typing import Any, List, Optional

from contractshield.core.result import Severity

from .scanner import VulnerabilityFinding, VulnerabilityType, truncate_value


class NoSQLInjectionChecker:
    """
    NoSQL Injection vulnerability checker.

    Detects MongoDB and other NoSQL injection patterns.
    """

    # MongoDB operator patterns (when found in strings)
    MONGO_OPERATORS = [
        re.compile(r'"\$(?:eq|ne|gt|gte|lt|lte|in|nin|and|or|not|nor|exists|type|regex|where|expr)"', re.IGNORECASE),
        re.compile(r"'\$(?:eq|ne|gt|gte|lt|lte|in|nin|and|or|not|nor|exists|type|regex|where|expr)'", re.IGNORECASE),
        re.compile(r"\$where\s*:", re.IGNORECASE),
        re.compile(r"\$regex\s*:", re.IGNORECASE),
        re.compile(r"\$expr\s*:", re.IGNORECASE),
    ]

    # JavaScript injection in MongoDB $where
    JS_INJECTION = [
        re.compile(r"function\s*\(\s*\)", re.IGNORECASE),
        re.compile(r"this\.\w+\s*[=!<>]", re.IGNORECASE),
        re.compile(r"db\.\w+\.find", re.IGNORECASE),
        re.compile(r"sleep\s*\(\s*\d+\s*\)", re.IGNORECASE),
    ]

    # Dangerous keys when found as dict keys (not string values)
    DANGEROUS_KEYS = frozenset([
        "$where",
        "$regex",
        "$ne",
        "$gt",
        "$gte",
        "$lt",
        "$lte",
        "$in",
        "$nin",
        "$and",
        "$or",
        "$not",
        "$nor",
        "$exists",
        "$type",
        "$expr",
        "$jsonSchema",
        "$mod",
        "$text",
        "$search",
    ])

    def check(
        self, value: Any, path: str, fields: Optional[List[str]] = None
    ) -> List[VulnerabilityFinding]:
        """Check value for NoSQL injection patterns."""
        findings: List[VulnerabilityFinding] = []

        if isinstance(value, str):
            findings.extend(self._check_string(value, path))
        elif isinstance(value, dict):
            findings.extend(self._check_dict(value, path))

        return findings

    def _check_string(self, value: str, path: str) -> List[VulnerabilityFinding]:
        """Check string for NoSQL injection patterns."""
        findings: List[VulnerabilityFinding] = []

        if len(value) < 3:
            return findings

        # Check for MongoDB operators in strings
        for pattern in self.MONGO_OPERATORS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.NOSQL_INJECTION,
                        severity=Severity.HIGH,
                        path=path,
                        value=truncate_value(value),
                        message=f"NoSQL operator in string value: {pattern.pattern[:40]}",
                    )
                )
                return findings

        # Check for JavaScript injection
        for pattern in self.JS_INJECTION:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.NOSQL_INJECTION,
                        severity=Severity.CRITICAL,
                        path=path,
                        value=truncate_value(value),
                        message="Potential JavaScript injection in NoSQL query",
                    )
                )
                return findings

        return findings

    def _check_dict(self, value: dict, path: str) -> List[VulnerabilityFinding]:
        """Check dictionary keys for NoSQL operator injection."""
        findings: List[VulnerabilityFinding] = []

        for key in value.keys():
            if not isinstance(key, str):
                continue

            # Check for dangerous operators as keys
            if key.lower() in {k.lower() for k in self.DANGEROUS_KEYS}:
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.NOSQL_INJECTION,
                        severity=Severity.CRITICAL,
                        path=f"{path}.{key}",
                        value=truncate_value(str(key)),
                        message=f"NoSQL operator injection via key: {key}",
                    )
                )

            # Check for $ prefix (MongoDB operators)
            elif key.startswith("$"):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.NOSQL_INJECTION,
                        severity=Severity.HIGH,
                        path=f"{path}.{key}",
                        value=truncate_value(str(key)),
                        message=f"Suspicious NoSQL operator key: {key}",
                    )
                )

        return findings
