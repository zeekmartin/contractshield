"""SSRF (Server-Side Request Forgery) detection."""

import re
from ipaddress import ip_address, ip_network
from typing import Any, List, Optional
from urllib.parse import urlparse

from contractshield.core.result import Severity

from .scanner import VulnerabilityFinding, VulnerabilityType, truncate_value


class SSRFChecker:
    """
    SSRF vulnerability checker.

    Detects attempts to access internal/private network resources
    via URL-like values.
    """

    # Private/internal IP ranges (RFC 1918, RFC 4193, etc.)
    PRIVATE_NETWORKS = [
        ip_network("10.0.0.0/8"),
        ip_network("172.16.0.0/12"),
        ip_network("192.168.0.0/16"),
        ip_network("127.0.0.0/8"),
        ip_network("169.254.0.0/16"),  # Link-local
        ip_network("::1/128"),  # IPv6 loopback
        ip_network("fc00::/7"),  # IPv6 private
        ip_network("fe80::/10"),  # IPv6 link-local
    ]

    # Dangerous hostnames
    INTERNAL_HOSTNAMES = frozenset([
        "localhost",
        "127.0.0.1",
        "0.0.0.0",
        "[::]",
        "[::1]",
        "0",
        "0.0.0.0:0",
    ])

    # Cloud metadata endpoints
    CLOUD_METADATA = [
        re.compile(r"169\.254\.169\.254", re.IGNORECASE),  # AWS/GCP/Azure
        re.compile(r"metadata\.google\.internal", re.IGNORECASE),
        re.compile(r"metadata\.azure\.internal", re.IGNORECASE),
        re.compile(r"100\.100\.100\.200", re.IGNORECASE),  # Alibaba Cloud
    ]

    # URL schemes to check
    URL_SCHEMES = frozenset(["http", "https", "ftp", "gopher", "file", "dict"])

    # Dangerous URL patterns
    DANGEROUS_PATTERNS = [
        re.compile(r"file://", re.IGNORECASE),
        re.compile(r"gopher://", re.IGNORECASE),
        re.compile(r"dict://", re.IGNORECASE),
        re.compile(r"@.*:", re.IGNORECASE),  # URL with credentials
    ]

    def check(
        self, value: Any, path: str, fields: Optional[List[str]] = None
    ) -> List[VulnerabilityFinding]:
        """Check value for SSRF patterns."""
        findings: List[VulnerabilityFinding] = []

        if not isinstance(value, str):
            return findings

        # Skip short strings that can't be URLs
        if len(value) < 7:  # Minimum: http://
            return findings

        # Check for dangerous URL schemes first
        for pattern in self.DANGEROUS_PATTERNS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.SSRF_INTERNAL,
                        severity=Severity.CRITICAL,
                        path=path,
                        value=truncate_value(value),
                        message=f"Dangerous URL scheme detected: {pattern.pattern[:30]}",
                    )
                )
                return findings

        # Check for cloud metadata endpoints
        for pattern in self.CLOUD_METADATA:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.SSRF_INTERNAL,
                        severity=Severity.CRITICAL,
                        path=path,
                        value=truncate_value(value),
                        message="Cloud metadata endpoint access attempt detected",
                    )
                )
                return findings

        # Try to parse as URL
        try:
            parsed = urlparse(value)

            # Only check URL-like strings
            if parsed.scheme.lower() not in self.URL_SCHEMES:
                return findings

            hostname = parsed.hostname
            if not hostname:
                return findings

            # Check for internal hostnames
            hostname_lower = hostname.lower()
            if hostname_lower in self.INTERNAL_HOSTNAMES:
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.SSRF_INTERNAL,
                        severity=Severity.HIGH,
                        path=path,
                        value=truncate_value(value),
                        message=f"Internal hostname detected: {hostname}",
                    )
                )
                return findings

            # Check for private IP addresses
            try:
                ip = ip_address(hostname)
                for network in self.PRIVATE_NETWORKS:
                    if ip in network:
                        findings.append(
                            VulnerabilityFinding(
                                type=VulnerabilityType.SSRF_INTERNAL,
                                severity=Severity.HIGH,
                                path=path,
                                value=truncate_value(value),
                                message=f"Private IP address detected: {hostname}",
                            )
                        )
                        return findings
            except ValueError:
                # Not a valid IP, check for suspicious patterns
                if self._is_suspicious_hostname(hostname_lower):
                    findings.append(
                        VulnerabilityFinding(
                            type=VulnerabilityType.SSRF_INTERNAL,
                            severity=Severity.MEDIUM,
                            path=path,
                            value=truncate_value(value),
                            message=f"Suspicious hostname pattern: {hostname}",
                        )
                    )
                    return findings

        except Exception:
            # Not a valid URL, ignore
            pass

        return findings

    def _is_suspicious_hostname(self, hostname: str) -> bool:
        """Check for suspicious hostname patterns."""
        suspicious_patterns = [
            "internal",
            "intranet",
            "private",
            "local",
            ".local",
            ".internal",
            ".corp",
            ".home",
            ".lan",
        ]
        return any(pattern in hostname for pattern in suspicious_patterns)
