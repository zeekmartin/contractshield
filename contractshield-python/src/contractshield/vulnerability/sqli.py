"""SQL Injection detection."""

import re
from typing import Any, List, Optional

from contractshield.core.result import Severity

from .scanner import VulnerabilityFinding, VulnerabilityType, truncate_value


class SQLiChecker:
    """
    SQL Injection vulnerability checker.

    Detects common SQL injection patterns in string values.
    """

    # Common SQL injection patterns
    PATTERNS = [
        # Comment-based
        re.compile(r"--\s*$", re.IGNORECASE),
        re.compile(r"/\*.*\*/", re.IGNORECASE),
        re.compile(r"#\s*$"),
        # Union-based
        re.compile(r"\bUNION\s+(ALL\s+)?SELECT\b", re.IGNORECASE),
        # Boolean-based
        re.compile(r"\bOR\s+1\s*=\s*1\b", re.IGNORECASE),
        re.compile(r"\bAND\s+1\s*=\s*1\b", re.IGNORECASE),
        re.compile(r"\bOR\s+['\"]?1['\"]?\s*=\s*['\"]?1['\"]?", re.IGNORECASE),
        re.compile(r"'\s*OR\s*'", re.IGNORECASE),
        # Stacked queries
        re.compile(r";\s*SELECT\b", re.IGNORECASE),
        re.compile(r";\s*INSERT\b", re.IGNORECASE),
        re.compile(r";\s*UPDATE\b", re.IGNORECASE),
        re.compile(r";\s*DELETE\b", re.IGNORECASE),
        re.compile(r";\s*DROP\b", re.IGNORECASE),
        re.compile(r";\s*TRUNCATE\b", re.IGNORECASE),
        # Time-based
        re.compile(r"\bWAITFOR\s+DELAY\b", re.IGNORECASE),
        re.compile(r"\bSLEEP\s*\(", re.IGNORECASE),
        re.compile(r"\bBENCHMARK\s*\(", re.IGNORECASE),
        # Information extraction
        re.compile(r"\bINFORMATION_SCHEMA\b", re.IGNORECASE),
        re.compile(r"\bsys\.\w+\b", re.IGNORECASE),
        # Quote escaping
        re.compile(r"''\s*OR", re.IGNORECASE),
        re.compile(r"\\'\s*OR", re.IGNORECASE),
    ]

    # High-risk keywords that need context
    KEYWORDS = [
        "SELECT", "INSERT", "UPDATE", "DELETE", "DROP", "TRUNCATE",
        "EXEC", "EXECUTE", "xp_", "sp_", "GRANT", "REVOKE",
    ]

    def check(
        self, value: Any, path: str, fields: Optional[List[str]] = None
    ) -> List[VulnerabilityFinding]:
        """Check value for SQL injection patterns."""
        findings: List[VulnerabilityFinding] = []

        if not isinstance(value, str):
            return findings

        # Skip very short strings
        if len(value) < 3:
            return findings

        # Check patterns
        for pattern in self.PATTERNS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.SQLI,
                        severity=Severity.CRITICAL,
                        path=path,
                        value=truncate_value(value),
                        message=f"Potential SQL injection pattern detected: {pattern.pattern[:50]}",
                    )
                )
                return findings  # One finding per value is enough

        return findings
