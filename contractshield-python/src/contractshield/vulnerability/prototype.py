"""Prototype Pollution detection."""

from typing import Any, List, Optional

from contractshield.core.result import Severity

from .scanner import VulnerabilityFinding, VulnerabilityType, truncate_value


class PrototypePollutionChecker:
    """
    Prototype Pollution vulnerability checker.

    Detects attempts to pollute JavaScript object prototypes via JSON keys.
    While Python doesn't have prototype pollution, APIs often pass data to
    JavaScript frontends or Node.js services.
    """

    # Dangerous keys that can lead to prototype pollution
    DANGEROUS_KEYS = frozenset(
        [
            "__proto__",
            "constructor",
            "prototype",
            "__defineGetter__",
            "__defineSetter__",
            "__lookupGetter__",
            "__lookupSetter__",
            "__noSuchMethod__",
        ]
    )

    def check(
        self, value: Any, path: str, fields: Optional[List[str]] = None
    ) -> List[VulnerabilityFinding]:
        """Check value for prototype pollution patterns."""
        findings: List[VulnerabilityFinding] = []

        # Only check strings (which would be dictionary keys in our scanner)
        if not isinstance(value, str):
            return findings

        # Check if the value matches a dangerous key
        if value in self.DANGEROUS_KEYS:
            findings.append(
                VulnerabilityFinding(
                    type=VulnerabilityType.PROTOTYPE_POLLUTION,
                    severity=Severity.CRITICAL,
                    path=path,
                    value=truncate_value(value),
                    message=f"Prototype pollution attempt via key '{value}'",
                )
            )

        # Also check for case variations
        if value.lower() in {k.lower() for k in self.DANGEROUS_KEYS}:
            if value not in self.DANGEROUS_KEYS:  # Don't double-report
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.PROTOTYPE_POLLUTION,
                        severity=Severity.HIGH,
                        path=path,
                        value=truncate_value(value),
                        message=f"Possible prototype pollution attempt via key '{value}'",
                    )
                )

        return findings
