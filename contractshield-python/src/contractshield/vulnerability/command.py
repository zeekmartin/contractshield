"""Command Injection detection."""

import re
from typing import Any, List, Optional

from contractshield.core.result import Severity

from .scanner import VulnerabilityFinding, VulnerabilityType, truncate_value


class CommandInjectionChecker:
    """
    Command Injection vulnerability checker.

    Detects shell command injection patterns in string values.
    """

    # Shell metacharacters and command separators
    SHELL_PATTERNS = [
        # Command chaining
        re.compile(r";\s*\w+", re.IGNORECASE),  # ; command
        re.compile(r"\|\s*\w+", re.IGNORECASE),  # | command
        re.compile(r"\|\|", re.IGNORECASE),  # || (or)
        re.compile(r"&&", re.IGNORECASE),  # && (and)
        re.compile(r"`[^`]+`"),  # Backtick command substitution
        re.compile(r"\$\([^)]+\)"),  # $() command substitution
        # Redirections
        re.compile(r">\s*/", re.IGNORECASE),  # > /path
        re.compile(r">>\s*/", re.IGNORECASE),  # >> /path
        re.compile(r"<\s*/", re.IGNORECASE),  # < /path
        # Newline injection
        re.compile(r"\n\s*\w+"),  # Newline followed by command
        re.compile(r"\r\n\s*\w+"),  # CRLF injection
    ]

    # Dangerous shell commands
    DANGEROUS_COMMANDS = [
        re.compile(r"\b(?:bash|sh|zsh|csh|ksh|fish)\s+-c\b", re.IGNORECASE),
        re.compile(r"\b(?:curl|wget)\s+", re.IGNORECASE),
        re.compile(r"\brm\s+-[rf]+\b", re.IGNORECASE),
        re.compile(r"\bchmod\s+[0-7]{3,4}\b", re.IGNORECASE),
        re.compile(r"\bchown\b", re.IGNORECASE),
        re.compile(r"\bnc\s+", re.IGNORECASE),  # netcat
        re.compile(r"\bnetcat\b", re.IGNORECASE),
        re.compile(r"\bpython\s+-c\b", re.IGNORECASE),
        re.compile(r"\bperl\s+-e\b", re.IGNORECASE),
        re.compile(r"\bruby\s+-e\b", re.IGNORECASE),
        re.compile(r"\bnode\s+-e\b", re.IGNORECASE),
        re.compile(r"\bphp\s+-r\b", re.IGNORECASE),
        re.compile(r"\b/bin/", re.IGNORECASE),
        re.compile(r"\b/usr/bin/", re.IGNORECASE),
        re.compile(r"\b/etc/passwd\b", re.IGNORECASE),
        re.compile(r"\b/etc/shadow\b", re.IGNORECASE),
    ]

    # Windows command patterns
    WINDOWS_PATTERNS = [
        re.compile(r"\bcmd\s*/c\b", re.IGNORECASE),
        re.compile(r"\bpowershell\b", re.IGNORECASE),
        re.compile(r"\bpwsh\b", re.IGNORECASE),
        re.compile(r"%\w+%"),  # Environment variable expansion
        re.compile(r"\bnet\s+user\b", re.IGNORECASE),
        re.compile(r"\bnet\s+localgroup\b", re.IGNORECASE),
    ]

    def check(
        self, value: Any, path: str, fields: Optional[List[str]] = None
    ) -> List[VulnerabilityFinding]:
        """Check value for command injection patterns."""
        findings: List[VulnerabilityFinding] = []

        if not isinstance(value, str):
            return findings

        # Skip very short strings
        if len(value) < 2:
            return findings

        # Check shell metacharacter patterns
        for pattern in self.SHELL_PATTERNS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.COMMAND_INJECTION,
                        severity=Severity.CRITICAL,
                        path=path,
                        value=truncate_value(value),
                        message=f"Shell metacharacter pattern detected: {pattern.pattern[:40]}",
                    )
                )
                return findings  # One finding is enough

        # Check dangerous commands
        for pattern in self.DANGEROUS_COMMANDS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.COMMAND_INJECTION,
                        severity=Severity.CRITICAL,
                        path=path,
                        value=truncate_value(value),
                        message=f"Dangerous command pattern detected: {pattern.pattern[:40]}",
                    )
                )
                return findings

        # Check Windows patterns
        for pattern in self.WINDOWS_PATTERNS:
            if pattern.search(value):
                findings.append(
                    VulnerabilityFinding(
                        type=VulnerabilityType.COMMAND_INJECTION,
                        severity=Severity.HIGH,
                        path=path,
                        value=truncate_value(value),
                        message=f"Windows command pattern detected: {pattern.pattern[:40]}",
                    )
                )
                return findings

        return findings
