package dev.contractshield.core.vulnerability.checks;

import dev.contractshield.core.vulnerability.Severity;
import dev.contractshield.core.vulnerability.VulnerabilityFinding;
import dev.contractshield.core.vulnerability.VulnerabilityType;

import java.util.List;
import java.util.Optional;
import java.util.regex.Pattern;

/**
 * Detects path/directory traversal patterns in string values.
 */
public class PathTraversalCheck implements VulnerabilityCheck {

    private static final List<Pattern> PATTERNS = List.of(
            // Basic traversal
            Pattern.compile("\\.\\./"),
            Pattern.compile("\\.\\.\\\\"),
            // URL encoded
            Pattern.compile("%2e%2e[%/\\\\]", Pattern.CASE_INSENSITIVE),
            Pattern.compile("%252e%252e", Pattern.CASE_INSENSITIVE),
            // Double encoding
            Pattern.compile("\\.\\.%2f", Pattern.CASE_INSENSITIVE),
            Pattern.compile("\\.\\.%5c", Pattern.CASE_INSENSITIVE),
            // Null byte injection
            Pattern.compile("%00"),
            Pattern.compile("\\x00"),
            // Absolute paths (Unix)
            Pattern.compile("^/etc/"),
            Pattern.compile("^/var/"),
            Pattern.compile("^/usr/"),
            Pattern.compile("^/home/"),
            Pattern.compile("^/root/"),
            // Absolute paths (Windows)
            Pattern.compile("^[a-zA-Z]:\\\\", Pattern.CASE_INSENSITIVE),
            Pattern.compile("\\\\\\\\[^\\\\]+\\\\", Pattern.CASE_INSENSITIVE)
    );

    private static final List<String> SENSITIVE_FILES = List.of(
            "/etc/passwd",
            "/etc/shadow",
            "/etc/hosts",
            "web.config",
            ".htaccess",
            ".env",
            "wp-config.php"
    );

    @Override
    public Optional<VulnerabilityFinding> check(String value, String path) {
        if (value == null || value.length() < 2) {
            return Optional.empty();
        }

        // Check patterns
        for (Pattern pattern : PATTERNS) {
            if (pattern.matcher(value).find()) {
                return Optional.of(VulnerabilityFinding.of(
                        VulnerabilityType.PATH_TRAVERSAL,
                        Severity.HIGH,
                        path,
                        value,
                        "Path traversal pattern detected"
                ));
            }
        }

        // Check for sensitive file access
        String lowerValue = value.toLowerCase();
        for (String sensitiveFile : SENSITIVE_FILES) {
            if (lowerValue.contains(sensitiveFile.toLowerCase())) {
                return Optional.of(VulnerabilityFinding.of(
                        VulnerabilityType.PATH_TRAVERSAL,
                        Severity.CRITICAL,
                        path,
                        value,
                        "Attempt to access sensitive file detected"
                ));
            }
        }

        return Optional.empty();
    }
}
