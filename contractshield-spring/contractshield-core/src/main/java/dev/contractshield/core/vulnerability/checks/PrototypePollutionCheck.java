package dev.contractshield.core.vulnerability.checks;

import dev.contractshield.core.vulnerability.Severity;
import dev.contractshield.core.vulnerability.VulnerabilityFinding;
import dev.contractshield.core.vulnerability.VulnerabilityType;

import java.util.Optional;
import java.util.Set;

/**
 * Detects prototype pollution patterns in field names and values.
 * <p>
 * While this is primarily a JavaScript vulnerability, detecting these
 * patterns helps protect downstream JavaScript consumers of the API.
 */
public class PrototypePollutionCheck implements VulnerabilityCheck {

    private static final Set<String> DANGEROUS_KEYS = Set.of(
            "__proto__",
            "constructor",
            "prototype"
    );

    @Override
    public Optional<VulnerabilityFinding> check(String value, String path) {
        if (value == null) {
            return Optional.empty();
        }

        String lowerValue = value.toLowerCase();

        // Exact match (case-insensitive)
        for (String key : DANGEROUS_KEYS) {
            if (key.equalsIgnoreCase(value)) {
                return Optional.of(VulnerabilityFinding.of(
                        VulnerabilityType.PROTOTYPE_POLLUTION,
                        Severity.CRITICAL,
                        path,
                        value,
                        "Prototype pollution attempt detected"
                ));
            }
        }

        // Check for prototype pollution in value content
        if (lowerValue.contains("__proto__") ||
            lowerValue.contains("[\"constructor\"]") ||
            lowerValue.contains("[\"prototype\"]")) {
            return Optional.of(VulnerabilityFinding.of(
                    VulnerabilityType.PROTOTYPE_POLLUTION,
                    Severity.HIGH,
                    path,
                    value,
                    "Prototype pollution pattern in value"
            ));
        }

        return Optional.empty();
    }

    /**
     * Check if a field name is a prototype pollution vector.
     */
    public boolean isDangerousKey(String key) {
        if (key == null) {
            return false;
        }
        String lowerKey = key.toLowerCase();
        return DANGEROUS_KEYS.stream()
                .anyMatch(k -> k.equalsIgnoreCase(lowerKey));
    }
}
