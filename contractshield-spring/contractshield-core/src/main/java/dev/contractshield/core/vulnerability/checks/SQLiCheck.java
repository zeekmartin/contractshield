package dev.contractshield.core.vulnerability.checks;

import dev.contractshield.core.vulnerability.Severity;
import dev.contractshield.core.vulnerability.VulnerabilityFinding;
import dev.contractshield.core.vulnerability.VulnerabilityType;

import java.util.List;
import java.util.Optional;
import java.util.regex.Pattern;

/**
 * Detects SQL injection patterns in string values.
 */
public class SQLiCheck implements VulnerabilityCheck {

    private static final List<Pattern> PATTERNS = List.of(
            // Comment-based
            Pattern.compile("--\\s*$", Pattern.CASE_INSENSITIVE),
            Pattern.compile("/\\*.*\\*/", Pattern.CASE_INSENSITIVE),
            Pattern.compile("#\\s*$"),
            // Union-based
            Pattern.compile("\\bUNION\\s+(ALL\\s+)?SELECT\\b", Pattern.CASE_INSENSITIVE),
            // Boolean-based
            Pattern.compile("\\bOR\\s+1\\s*=\\s*1\\b", Pattern.CASE_INSENSITIVE),
            Pattern.compile("\\bAND\\s+1\\s*=\\s*1\\b", Pattern.CASE_INSENSITIVE),
            Pattern.compile("\\bOR\\s+['\"]?1['\"]?\\s*=\\s*['\"]?1['\"]?", Pattern.CASE_INSENSITIVE),
            Pattern.compile("'\\s*OR\\s*'", Pattern.CASE_INSENSITIVE),
            // Stacked queries
            Pattern.compile(";\\s*SELECT\\b", Pattern.CASE_INSENSITIVE),
            Pattern.compile(";\\s*INSERT\\b", Pattern.CASE_INSENSITIVE),
            Pattern.compile(";\\s*UPDATE\\b", Pattern.CASE_INSENSITIVE),
            Pattern.compile(";\\s*DELETE\\b", Pattern.CASE_INSENSITIVE),
            Pattern.compile(";\\s*DROP\\b", Pattern.CASE_INSENSITIVE),
            Pattern.compile(";\\s*TRUNCATE\\b", Pattern.CASE_INSENSITIVE),
            // Time-based
            Pattern.compile("\\bWAITFOR\\s+DELAY\\b", Pattern.CASE_INSENSITIVE),
            Pattern.compile("\\bSLEEP\\s*\\(", Pattern.CASE_INSENSITIVE),
            Pattern.compile("\\bBENCHMARK\\s*\\(", Pattern.CASE_INSENSITIVE),
            // Information extraction
            Pattern.compile("\\bINFORMATION_SCHEMA\\b", Pattern.CASE_INSENSITIVE)
    );

    @Override
    public Optional<VulnerabilityFinding> check(String value, String path) {
        if (value == null || value.length() < 3) {
            return Optional.empty();
        }

        for (Pattern pattern : PATTERNS) {
            if (pattern.matcher(value).find()) {
                return Optional.of(VulnerabilityFinding.of(
                        VulnerabilityType.SQLI,
                        Severity.CRITICAL,
                        path,
                        value,
                        "Potential SQL injection pattern detected"
                ));
            }
        }

        return Optional.empty();
    }
}
