package dev.contractshield.core.vulnerability.checks;

import dev.contractshield.core.vulnerability.Severity;
import dev.contractshield.core.vulnerability.VulnerabilityFinding;
import dev.contractshield.core.vulnerability.VulnerabilityType;

import java.util.List;
import java.util.Optional;
import java.util.regex.Pattern;

/**
 * Detects Cross-Site Scripting (XSS) patterns in string values.
 */
public class XSSCheck implements VulnerabilityCheck {

    private static final List<Pattern> PATTERNS = List.of(
            // Script tags
            Pattern.compile("<script[^>]*>", Pattern.CASE_INSENSITIVE),
            Pattern.compile("</script>", Pattern.CASE_INSENSITIVE),
            // Event handlers
            Pattern.compile("\\bon\\w+\\s*=", Pattern.CASE_INSENSITIVE),
            // JavaScript protocol
            Pattern.compile("javascript:", Pattern.CASE_INSENSITIVE),
            Pattern.compile("vbscript:", Pattern.CASE_INSENSITIVE),
            Pattern.compile("data:", Pattern.CASE_INSENSITIVE),
            // SVG/XML injection
            Pattern.compile("<svg[^>]*onload", Pattern.CASE_INSENSITIVE),
            Pattern.compile("<img[^>]*onerror", Pattern.CASE_INSENSITIVE),
            // Expression injection
            Pattern.compile("expression\\s*\\(", Pattern.CASE_INSENSITIVE),
            // DOM manipulation
            Pattern.compile("document\\.cookie", Pattern.CASE_INSENSITIVE),
            Pattern.compile("document\\.location", Pattern.CASE_INSENSITIVE),
            Pattern.compile("window\\.location", Pattern.CASE_INSENSITIVE),
            // Eval and related
            Pattern.compile("\\beval\\s*\\(", Pattern.CASE_INSENSITIVE),
            Pattern.compile("\\bFunction\\s*\\(", Pattern.CASE_INSENSITIVE),
            // Encoded variants
            Pattern.compile("&#x?\\d+;?", Pattern.CASE_INSENSITIVE)
    );

    @Override
    public Optional<VulnerabilityFinding> check(String value, String path) {
        if (value == null || value.length() < 3) {
            return Optional.empty();
        }

        for (Pattern pattern : PATTERNS) {
            if (pattern.matcher(value).find()) {
                return Optional.of(VulnerabilityFinding.of(
                        VulnerabilityType.XSS,
                        Severity.HIGH,
                        path,
                        value,
                        "Potential XSS pattern detected"
                ));
            }
        }

        return Optional.empty();
    }
}
