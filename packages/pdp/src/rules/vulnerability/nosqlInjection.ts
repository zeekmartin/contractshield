import { RuleHit } from "../../types.js";

/**
 * MongoDB operators that can be used for NoSQL injection.
 * These are dangerous when user input is directly used in queries.
 */
const DANGEROUS_OPERATORS = new Set([
  // Comparison
  "$eq", "$gt", "$gte", "$in", "$lt", "$lte", "$ne", "$nin",
  // Logical
  "$and", "$not", "$nor", "$or",
  // Element
  "$exists", "$type",
  // Evaluation (especially dangerous)
  "$expr", "$jsonSchema", "$mod", "$regex", "$text", "$where",
  // Array
  "$all", "$elemMatch", "$size",
  // Bitwise
  "$bitsAllClear", "$bitsAllSet", "$bitsAnyClear", "$bitsAnySet",
  // Projection
  "$", "$meta", "$slice",
  // Update operators (also dangerous in some contexts)
  "$inc", "$min", "$max", "$mul", "$rename", "$set", "$setOnInsert", "$unset",
  "$addToSet", "$pop", "$pull", "$push", "$pullAll",
  "$each", "$position", "$sort",
  "$bit", "$currentDate",
]);

/**
 * Check for NoSQL injection patterns in JSON objects.
 * Detects MongoDB operators ($gt, $where, etc.) in keys.
 *
 * @param data - The data to scan (usually request body)
 * @returns Array of RuleHits if NoSQL injection patterns found
 */
export function checkNosqlInjection(data: unknown): RuleHit[] {
  const hits: RuleHit[] = [];
  const foundOperators: string[] = [];

  scanForOperators(data, "", foundOperators);

  if (foundOperators.length > 0) {
    hits.push({
      id: "vulnerability.nosqlInjection",
      severity: "critical",
      message: `NoSQL injection attempt detected: ${foundOperators.join(", ")}`,
    });
  }

  return hits;
}

function scanForOperators(obj: unknown, path: string, found: string[]): void {
  if (obj === null || typeof obj !== "object") {
    return;
  }

  if (Array.isArray(obj)) {
    for (let i = 0; i < obj.length; i++) {
      scanForOperators(obj[i], `${path}[${i}]`, found);
    }
    return;
  }

  for (const key of Object.keys(obj)) {
    const currentPath = path ? `${path}.${key}` : key;

    // Check if key is a MongoDB operator
    if (key.startsWith("$")) {
      const lowerKey = key.toLowerCase();
      if (DANGEROUS_OPERATORS.has(lowerKey) || DANGEROUS_OPERATORS.has(key)) {
        found.push(`${currentPath}`);
      }
    }

    // Also check string values for operator patterns (could be JSON stringified)
    const value = (obj as Record<string, unknown>)[key];
    if (typeof value === "string" && value.startsWith("$") && DANGEROUS_OPERATORS.has(value)) {
      found.push(`${currentPath} (value)`);
    }

    scanForOperators(value, currentPath, found);
  }
}
