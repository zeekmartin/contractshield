import { RuleHit } from "../../types.js";

/** Dangerous keys that can lead to prototype pollution. */
const DANGEROUS_KEYS = new Set(["__proto__", "constructor", "prototype"]);

/**
 * Check for prototype pollution attack patterns in JSON objects.
 * Recursively scans all keys in the object tree.
 *
 * @param data - The data to scan (usually request body)
 * @returns Array of RuleHits if dangerous keys found
 */
export function checkPrototypePollution(data: unknown): RuleHit[] {
  const hits: RuleHit[] = [];
  const foundPaths: string[] = [];

  scanForDangerousKeys(data, "", foundPaths);

  if (foundPaths.length > 0) {
    hits.push({
      id: "vulnerability.prototypePollution",
      severity: "critical",
      message: `Prototype pollution attempt detected at: ${foundPaths.join(", ")}`,
    });
  }

  return hits;
}

function scanForDangerousKeys(obj: unknown, path: string, found: string[]): void {
  if (obj === null || typeof obj !== "object") {
    return;
  }

  if (Array.isArray(obj)) {
    for (let i = 0; i < obj.length; i++) {
      scanForDangerousKeys(obj[i], `${path}[${i}]`, found);
    }
    return;
  }

  for (const key of Object.keys(obj)) {
    const currentPath = path ? `${path}.${key}` : key;

    if (DANGEROUS_KEYS.has(key)) {
      found.push(currentPath);
    }

    scanForDangerousKeys((obj as Record<string, unknown>)[key], currentPath, found);
  }
}
