import { RuleHit, RequestContext, VulnerabilityChecksConfig } from "../../types.js";
import { checkPrototypePollution } from "./prototypePollution.js";
import { checkSsrfInternal } from "./ssrfInternal.js";
import { checkPathTraversal } from "./pathTraversal.js";
import { checkNosqlInjection } from "./nosqlInjection.js";
import { checkCommandInjection } from "./commandInjection.js";

/** Default configuration for vulnerability checks. */
const DEFAULT_CONFIG: Required<VulnerabilityChecksConfig> = {
  prototypePollution: true,
  pathTraversal: true,
  ssrfInternal: true,
  commandInjection: false, // Opt-in due to false positive risk
  nosqlInjection: false,   // Opt-in
};

/**
 * Merge global defaults with route-level overrides.
 * Route config takes precedence over global config.
 */
export function mergeVulnerabilityConfig(
  globalConfig?: VulnerabilityChecksConfig,
  routeConfig?: VulnerabilityChecksConfig
): VulnerabilityChecksConfig {
  return {
    ...DEFAULT_CONFIG,
    ...globalConfig,
    ...routeConfig,
  };
}

/**
 * Run all enabled vulnerability checks against the request context.
 * This should be called BEFORE contract validation in the PDP pipeline.
 *
 * @param ctx - The request context
 * @param config - Merged vulnerability check configuration
 * @returns Array of RuleHits from all enabled checks
 */
export function checkVulnerabilities(
  ctx: RequestContext,
  config: VulnerabilityChecksConfig
): RuleHit[] {
  const hits: RuleHit[] = [];

  // Get the body sample for scanning
  const body = ctx.request.body?.json?.sample;
  const query = ctx.request.query;

  // Combine body and query for scanning
  const dataToScan = {
    body: body ?? {},
    query: query ?? {},
  };

  // 1. Prototype Pollution (default: on)
  if (config.prototypePollution !== false) {
    hits.push(...checkPrototypePollution(dataToScan));
  }

  // 2. Path Traversal (default: on)
  if (config.pathTraversal !== false) {
    const pathTraversalConfig = typeof config.pathTraversal === "object"
      ? config.pathTraversal
      : {};
    hits.push(...checkPathTraversal(dataToScan, pathTraversalConfig));
  }

  // 3. SSRF Internal (default: on)
  if (config.ssrfInternal !== false) {
    const ssrfConfig = typeof config.ssrfInternal === "object"
      ? config.ssrfInternal
      : {};
    hits.push(...checkSsrfInternal(dataToScan, ssrfConfig));
  }

  // 4. NoSQL Injection (default: off, opt-in)
  if (config.nosqlInjection === true) {
    hits.push(...checkNosqlInjection(dataToScan));
  }

  // 5. Command Injection (default: off, opt-in)
  if (config.commandInjection !== false && config.commandInjection !== undefined) {
    const cmdConfig = typeof config.commandInjection === "object"
      ? config.commandInjection
      : {};
    hits.push(...checkCommandInjection(dataToScan, cmdConfig));
  }

  return hits;
}

// Re-export individual checks for testing
export { checkPrototypePollution } from "./prototypePollution.js";
export { checkSsrfInternal } from "./ssrfInternal.js";
export { checkPathTraversal } from "./pathTraversal.js";
export { checkNosqlInjection } from "./nosqlInjection.js";
export { checkCommandInjection } from "./commandInjection.js";
